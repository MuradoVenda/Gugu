<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gem Math Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #FF9800; --secondary: #4CAF50; --bg: #2D4C3E; --error: #F44336; --blue: #2196F3; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; touch-action: manipulation; }
        
        .app-container { background: white; border-radius: 25px; width: 92%; max-width: 450px; height: 92vh; display: flex; flex-direction: column; padding: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); position: relative; }
        
        /* Ï∫êÎ¶≠ÌÑ∞ (ÎààÎèôÏûê Ïï†ÎãàÎ©îÏù¥ÏÖò) */
        .character-box { height: 90px; display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 5px; }
        .eye { width: 50px; height: 50px; background: white; border: 4px solid #333; border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .pupil { width: 20px; height: 20px; background: #333; border-radius: 50%; position: absolute; transition: 0.1s; }
        
        .eye.heart::before { content: '‚ù§Ô∏è'; font-size: 30px; position: absolute; z-index: 2; animation: pop 0.3s; }
        .eye.spin .pupil { width: 35px; height: 35px; background: repeating-conic-gradient(#333 0 90deg, #fff 0 180deg); animation: rotateSpin 0.2s infinite linear; }
        @keyframes rotateSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes lookAround { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-10px, 0); } 75% { transform: translate(10px, 0); } }
        .looking .pupil { animation: lookAround 2.5s infinite ease-in-out; }

        .screen { display: none; flex-direction: column; height: 100%; }
        .screen.active { display: flex; }

        .grid-9 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
        .btn-table { aspect-ratio: 1/1; font-family: 'Fredoka One'; font-size: 1rem; border: none; border-radius: 18px; background: #f0f0f0; cursor: pointer; position: relative; box-shadow: 0 4px 0 #ddd; }
        .btn-table.unlocked { background: var(--primary); color: white; box-shadow: 0 4px 0 #E68A00; }
        .badge-mini { position: absolute; top: -8px; right: -8px; font-size: 20px; }

        .quiz-box { text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .question { font-size: 3.2rem; font-family: 'Fredoka One'; color: var(--bg); margin-bottom: 15px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-opt { padding: 15px; font-size: 1.4rem; font-weight: 900; border: 3px solid #eee; border-radius: 15px; background: white; cursor: pointer; box-shadow: 0 4px 0 #eee; transition: 0.1s; }
        .btn-opt:active { transform: translateY(3px); box-shadow: none; }
        
        input[type="number"] { width: 130px; padding: 10px; font-size: 2.2rem; text-align: center; border: 5px solid var(--secondary); border-radius: 20px; outline: none; font-family: 'Fredoka One'; }

        /* ÌïòÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Ïª®Ìä∏Î°§ */
        .nav-controls { display: flex; gap: 10px; margin-top: auto; }
        .btn-nav { padding: 12px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; background: #eee; flex: 1; font-size: 1rem; font-family: 'Nunito', sans-serif; }
        .btn-back-mode { background: #E3F2FD; color: #1976D2; }
        .btn-quit { background: #FFEBEE; color: #E53935; }

        .feedback-text { height: 35px; text-align: center; font-size: 1.1rem; font-weight: 800; margin: 10px 0; }
        
        .progress-dots { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; justify-items: center; margin: 0 auto 10px; width: 150px; }
        .dot { width: 14px; height: 14px; border-radius: 50%; background: #ddd; border: 2px solid #ccc; }
        .dot.active { background: var(--secondary); border-color: #388E3C; transform: scale(1.1); }
    </style>
</head>
<body onclick="initAudio()">

<div class="app-container">
    <div class="character-box">
        <div class="eye looking" id="eyeL"><div class="pupil"></div></div>
        <div class="eye looking" id="eyeR"><div class="pupil"></div></div>
    </div>

    <div id="screen-main" class="screen active">
        <h2 style="text-align:center; color: var(--bg);">Gem Math Master üíé</h2>
        <div class="grid-9" id="table-grid"></div>
        <button class="btn-nav" style="margin-top:auto" onclick="resetData()">Reset All Badges</button>
    </div>

    <div id="screen-mode" class="screen">
        <h2 id="selected-table-title" style="text-align:center; font-size: 1.8rem; margin-top: 20px;">Table 2</h2>
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 15px;">
            <button class="btn-opt" style="background:#E8F5E9; border-color: #C8E6C9;" onclick="startMode('training')">üéì TRAINING</button>
            <button class="btn-opt" style="background:#FFF3E0; border-color: #FFE0B2;" onclick="startMode('test')">üèÜ TEST (10 Questions)</button>
        </div>
        <button class="btn-nav" onclick="showScreen('main')">Go Back</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="quiz-box">
            <div id="mode-label" style="font-weight: 900; color: #aaa; margin-bottom: 5px;"></div>
            <div class="progress-dots" id="dots-container"></div>
            <div class="question" id="q-text"></div>
            <div id="input-area" style="display:none;">
                <input type="number" id="ans-input" inputmode="numeric" oninput="checkInputAnswer()">
            </div>
            <div class="options-grid" id="options-area"></div>
        </div>
        <div class="feedback-text" id="feedback"></div>
        
        <div class="nav-controls">
            <button class="btn-nav btn-back-mode" onclick="showScreen('mode')">BACK</button>
            <button class="btn-nav btn-quit" onclick="showScreen('main')">QUIT</button>
        </div>
    </div>
</div>

<script>
    let currentTable = 0;
    let currentMode = '';
    let correctAnswer = 0;
    let score = 0;
    const GOAL = 10;
    const badges = JSON.parse(localStorage.getItem('mathBadges')) || {};

    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'correct') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(520, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        } else {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(110, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.4);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
            osc.start(); osc.stop(audioCtx.currentTime + 0.4);
        }
    }

    function updateEyes(status) {
        const eyes = document.querySelectorAll('.eye');
        eyes.forEach(e => {
            e.className = 'eye';
            if (status === 'heart') e.classList.add('heart');
            else if (status === 'spin') e.classList.add('spin');
            else e.classList.add('looking');
        });
    }

    function initMenu() {
        const grid = document.getElementById('table-grid');
        grid.innerHTML = '';
        for (let i = 1; i <= 9; i++) {
            const btn = document.createElement('button');
            btn.className = `btn-table ${badges[i] ? 'unlocked' : ''}`;
            btn.innerHTML = `Table ${i} ${badges[i] ? '<span class="badge-mini">üíé</span>' : ''}`;
            btn.onclick = () => { currentTable = i; showScreen('mode'); };
            grid.appendChild(btn);
        }
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${id}`).classList.add('active');
        updateEyes('looking');
        if (id === 'main') initMenu();
        if (id === 'mode') {
            document.getElementById('selected-table-title').innerText = `Table ${currentTable}`;
        }
    }

    function startMode(mode) {
        currentMode = mode;
        score = 0;
        showScreen('game');
        document.getElementById('mode-label').innerText = mode.toUpperCase() + (mode === 'test' ? ' (0/10)' : '');
        updateProgress();
        nextQuestion();
    }

    function updateProgress() {
        const container = document.getElementById('dots-container');
        container.innerHTML = '';
        if (currentMode === 'test') {
            document.getElementById('mode-label').innerText = `TEST MODE (${score}/${GOAL})`;
            for (let i = 0; i < GOAL; i++) {
                const dot = document.createElement('div');
                dot.className = `dot ${i < score ? 'active' : ''}`;
                container.appendChild(dot);
            }
        }
    }

    function nextQuestion() {
        updateEyes('looking');
        document.getElementById('feedback').innerText = '';
        const mult = Math.floor(Math.random() * 9) + 1;
        correctAnswer = currentTable * mult;
        document.getElementById('q-text').innerText = `${currentTable} √ó ${mult} = ?`;

        if (currentMode === 'training') {
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('options-area').style.display = 'grid';
            generateOptions();
        } else {
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('options-area').style.display = 'none';
            const input = document.getElementById('ans-input');
            input.value = ''; input.focus();
        }
    }

    function generateOptions() {
        const area = document.getElementById('options-area');
        area.innerHTML = '';
        let opts = [correctAnswer];
        while (opts.length < 4) {
            let fake = currentTable * (Math.floor(Math.random() * 9) + 1);
            if (!opts.includes(fake)) opts.push(fake);
        }
        opts.sort(() => Math.random() - 0.5);
        opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'btn-opt';
            b.innerText = o;
            b.onclick = () => handleAnswer(o);
            area.appendChild(b);
        });
    }

    function checkInputAnswer() {
        const val = document.getElementById('ans-input').value;
        if (val.length >= String(correctAnswer).length) {
            handleAnswer(parseInt(val));
        }
    }

    function handleAnswer(ans) {
        if (ans === correctAnswer) {
            playSound('correct');
            updateEyes('heart');
            document.getElementById('feedback').style.color = "var(--secondary)";
            document.getElementById('feedback').innerText = "EXCELLENT! ‚ù§Ô∏è";
            score++;
            updateProgress();

            if (currentMode === 'test' && score >= GOAL) {
                badges[currentTable] = true;
                localStorage.setItem('mathBadges', JSON.stringify(badges));
                confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
                setTimeout(() => { alert("AMAZING! You cleared Table " + currentTable + "! üíé"); showScreen('main'); }, 1200);
            } else {
                setTimeout(nextQuestion, 1000);
            }
        } else {
            playSound('wrong');
            updateEyes('spin');
            document.getElementById('feedback').style.color = "var(--error)";
            document.getElementById('feedback').innerText = "Oops! Think again! üí®";
            if (currentMode === 'test') {
                score = 0;
                updateProgress();
                setTimeout(() => { document.getElementById('ans-input').value = ''; updateEyes('looking'); }, 800);
            }
        }
    }

    function resetData() {
        if (confirm("Reset all badges?")) {
            localStorage.clear();
            location.reload();
        }
    }

    initMenu();
</script>
</body>
</html>